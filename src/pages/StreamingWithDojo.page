<apex:page >
    <apex:includeScript value="https://ajax.googleapis.com/ajax/libs/dojo/1.4.3/dojo/dojo.xd.js"/>
    <apex:includeScript value="{!$Resource.common_cometd_js}"/>
    <apex:includeScript value="{!$Resource.dojo_cometd_js}"/>

    <script type="text/javascript">
        dojo.require("dojox.cometd");
        
        dojo.addOnLoad(function()
        {
            var _connected = false;
        
            function _connectionSucceeded()
            {
            }
        
            function _connectionBroken()
            {
                dojo.byId('body').innerHTML = 'CometD Connection Broken';
            }
            
            function _metaSubscribe(message)
            {
                var insurance = message.data.sobject.gwestr__Insurance__c;
                var rush = message.data.sobject.gwestr__Rush__c;
                var delivery = message.data.sobject.gwestr__Scheduled_Delivery__c;
                var email = message.data.sobject.gwestr__ContactEmail__c;
                var phone = message.data.sobject.gwestr__Contact_Phone__c;
                var status = message.data.sobject.gwestr__Status__c;
                var tracking = message.data.sobject.gwestr__TrackingExtId__c;
                var url = message.data.sobject.gwestr__Tracking_URL__c;
                var warnings = message.data.sobject.gwestr__Warnings__c;
                var weight = message.data.sobject.gwestr__Weight__c;
                var overweightPercent = message.data.sobject.gwestr__OverWeight__c;

                var newIdLabel = message.data.sobject.id;

                dojo.byId(newIdLabel).style.backgroundColor='Green';
                dojo.byId(newIdLabel).innerHTML = sensorValue;
                colorFade(newIdLabel, 'background', 'f9bcbc', 'ffffff',25, 90);
                dojo.byId(newIdLabel).style.backgroundColor='White';
                if(message.successful == false)
                {
                    alert("Subscribe failed");
                }
            }
        
            function _metaConnect(message)
            {
                var wasConnected = _connected;
                _connected = message.successful === true;
                if (!wasConnected && _connected)
                {
                    _connectionSucceeded();
                }
                else if (wasConnected && !_connected)
                {
                    _connectionBroken();
                }
            }
        
            var cometd = dojox.cometd;
        
            // Disconnect when the page unloads
            dojo.addOnUnload(function()
            {
                cometd.disconnect();
            });
        
            var auth = 'OAuth {!$Api.Session_ID}';
            var cometUrl = 'https://' + window.location.hostname + '/cometd/23.0/';
            cometd.init({
                url: cometUrl,
                requestHeaders: {Authorization: auth}
            });
            
            cometd.subscribe('/topic/shipment', _metaSubscribe);
            cometd.addListener('/meta/connect', _metaConnect);
        });
    </script>  

</apex:page>